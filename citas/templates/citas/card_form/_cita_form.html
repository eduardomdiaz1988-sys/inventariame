{% load widget_tweaks %}
<form id="citaFormFinal" method="post" action="{% url 'cita_create_card' %}" class="p-2">
  {% csrf_token %}

  <!-- Paso 1: Seleccionar Cliente -->
  <div id="card-cliente" class="card mb-3">
    <div class="card-header"><strong>Paso 1: Seleccionar Cliente</strong></div>
    <div class="card-body">
      <!-- Selector inicial -->
      <div class="mb-3">
        <label class="form-label">¿Es un cliente existente?</label>
        <div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="cliente_tipo" id="cliente_existente" value="existente" checked>
            <label class="form-check-label" for="cliente_existente">Sí</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="cliente_tipo" id="cliente_nuevo" value="nuevo">
            <label class="form-check-label" for="cliente_nuevo">No</label>
          </div>
        </div>
      </div>

      <!-- Buscador AJAX de cliente existente -->
      <div id="busquedaCliente" class="mb-3">
        <label for="buscador_cliente" class="form-label">Buscar cliente</label>
        <input type="text" id="buscador_cliente" class="form-control" placeholder="Escribe nombre o teléfono">
        <div id="resultados_cliente" class="list-group mt-2"></div>
      </div>

      <!-- Formulario de nuevo cliente con mapa -->
      <div id="formNuevoCliente" class="accordion mt-3 d-none">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingNuevoCliente">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNuevoCliente">
              Crear nuevo cliente
            </button>
          </h2>
          <div id="collapseNuevoCliente" class="accordion-collapse collapse" data-bs-parent="#formNuevoCliente">
            <div class="accordion-body">
              <div class="mb-3">
                <label for="id_nombre">Nombre</label>
                <input type="text" id="id_nombre" name="nombre" class="form-control">
              </div>
              <div class="mb-3">
                <label for="id_telefono">Teléfono</label>
                <input type="text" id="id_telefono" name="telefono" class="form-control" placeholder="Ej. 600123456">
              </div>

              <!-- Bloque de dirección con mapa -->
              <div class="row g-3">
                <div class="col-12 col-lg-8">
                  <div id="map" style="height: 300px; width: 100%; border-radius: 8px; border: 1px solid #eee;"></div>
                </div>
                <div class="col-12 col-lg-4">
                  <div class="card shadow-sm">
                    <div class="card-header bg-danger text-white">
                      <strong>Dirección del cliente</strong>
                    </div>
                    <div class="card-body">
                      <div class="mb-2">
                        <label class="form-label">Etiqueta</label>
                        <input type="text" id="labelField" name="label" class="form-control" placeholder="Ej. Casa, Almacén">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Dirección</label>
                        <input type="text" id="addressField" name="address" class="form-control" placeholder="Selecciona en el mapa" readonly>
                      </div>
                      <div class="row">
                        <div class="col-6 mb-2">
                          <label class="form-label">Latitud</label>
                          <input type="text" id="latField" name="latitude" class="form-control" readonly>
                        </div>
                        <div class="col-6 mb-2">
                          <label class="form-label">Longitud</label>
                          <input type="text" id="lngField" name="longitude" class="form-control" readonly>
                        </div>
                      </div>
                      <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" type="button" id="useMyLocationBtn">Usar mi ubicación</button>
                      </div>
                      <div class="form-text mt-2">Pulsa en el mapa para seleccionar un punto.</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Botón que solo copia datos y avanza -->
              <button type="button" id="btnCrearCliente" class="btn btn-danger mt-3">Continuar con este cliente</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Paso 2: Crear Cita -->
  <div id="card-cita" class="card mb-3 d-none">
    <div class="card-header"><strong>Paso 2: Crear Cita</strong></div>
    <div class="card-body">
      <!-- hidden cliente/dirección -->
      <input type="hidden" id="id_cliente_hidden" name="cliente">
      <input type="hidden" id="id_nombre_hidden" name="nombre">
      <input type="hidden" id="id_telefono_hidden" name="telefono">
      <input type="hidden" id="id_address_hidden" name="address">
      <input type="hidden" id="id_lat_hidden" name="latitude">
      <input type="hidden" id="id_lng_hidden" name="longitude">
      <input type="hidden" id="id_label_hidden" name="label">

      <!-- Campos de cita -->
      <div class="mb-3">
        {{ form.fecha.label_tag }}
        {{ form.fecha|add_class:"form-control" }}
      </div>

      <!-- Buscador AJAX de ofertas -->
      <div class="mb-3">
        <label for="buscador_oferta" class="form-label">Oferta</label>
        <input type="text" id="buscador_oferta" class="form-control" placeholder="Escribe nombre de la oferta">
        <div id="resultados_oferta" class="list-group mt-2"></div>
        <input type="hidden" id="id_oferta_hidden" name="oferta">
      </div>

      <!-- NUEVO CAMPO: número de instalación -->
      <div class="mb-3">
        {{ form.numero_instalacion.label_tag }}
        {{ form.numero_instalacion|add_class:"form-control" }}
      </div>

      <button type="button" id="btnResumen" class="btn btn-danger">Continuar al resumen</button>
      <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
    </div>
  </div>

  <!-- Paso 3: Resumen -->
  <div id="card-resumen" class="card mb-3 d-none">
    <div class="card-header"><strong>Paso 3: Resumen de la cita</strong></div>
    <div class="card-body">
      <ul class="list-group mb-3">
        <li class="list-group-item"><strong>Cliente:</strong> <span id="resCliente"></span></li>
        <li class="list-group-item"><strong>Teléfono:</strong> <span id="resTelefono"></span></li>
        <li class="list-group-item"><strong>Dirección:</strong> <span id="resDireccion"></span></li>
        <li class="list-group-item"><strong>Fecha:</strong> <span id="resFecha"></span></li>
        <li class="list-group-item"><strong>Oferta:</strong> <span id="resOferta"></span></li>
        <li class="list-group-item"><strong>Número de instalación:</strong> <span id="resNumeroInstalacion"></span></li>
      </ul>
      <!-- Botón final que envía todo el formulario -->
      <button type="submit" class="btn btn-success">Guardar cita</button>
      <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
    </div>
  </div>

</form>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const buscador = document.getElementById("buscador_oferta");
  const resultados = document.getElementById("resultados_oferta");
  const hiddenOferta = document.getElementById("id_oferta_hidden");
  const btnResumen = document.getElementById("btnResumen");

  // Buscador AJAX de ofertas
  buscador.addEventListener("input", function() {
    const q = this.value;
    if (q.length < 2) {
      resultados.innerHTML = "";
      return;
    }
    fetch(`/citas/buscar-ofertas/?q=${encodeURIComponent(q)}`)
      .then(res => res.json())
      .then(data => {
        resultados.innerHTML = "";
        data.forEach(oferta => {
          const item = document.createElement("button");
          item.type = "button";
          item.className = "list-group-item list-group-item-action";
          item.textContent = `${oferta.nombre} (${oferta.valor} €)`;
          item.onclick = () => {
            buscador.value = oferta.nombre;
            hiddenOferta.value = oferta.id;   // ✅ guardamos el id
            resultados.innerHTML = "";
          };
          resultados.appendChild(item);
        });
      });
  });

  // Validación antes de pasar al resumen
  btnResumen.addEventListener("click", function() {
    if (!hiddenOferta.value) {
      alert("Debes seleccionar una oferta antes de continuar.");
      return;
    }
    // Ocultamos paso 2 y mostramos paso 3
    document.getElementById("card-cita").classList.add("d-none");
    document.getElementById("card-resumen").classList.remove("d-none");

    // Rellenamos el resumen
    document.getElementById("resCliente").textContent = document.getElementById("id_nombre_hidden").value;
    document.getElementById("resTelefono").textContent = document.getElementById("id_telefono_hidden").value;
    document.getElementById("resDireccion").textContent = document.getElementById("id_address_hidden").value;
    document.getElementById("resFecha").textContent = document.getElementById("id_fecha").value;
    document.getElementById("resOferta").textContent = buscador.value;
    document.getElementById("resNumeroInstalacion").textContent = document.getElementById("id_numero_instalacion").value;
  });
});
</script>