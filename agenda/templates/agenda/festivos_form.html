<!-- calendario/templates/calendario/festivos_form.html -->
{% extends "base.html" %}
{% load static %}

{% block content_authenticated %}
<h2>Seleccionar festivos del mes</h2>

<form method="post" class="mt-3">
  {% csrf_token %}
  <div class="mb-3">
    {{ form.año.label_tag }}
    {{ form.año }}
  </div>
  <div class="mb-3">
    {{ form.mes.label_tag }}
    {{ form.mes }}
  </div>
  <div class="mb-3">
    {{ form.fechas.label_tag }}
    {{ form.fechas }}
    <div class="form-text">Selecciona uno o más días festivos del mes.</div>
  </div>
  <button type="submit" class="btn btn-primary">Guardar</button>
  <a href="{% url 'mantenimiento_list' %}" class="btn btn-outline-secondary">Volver</a>
</form>

<hr class="my-4">

<h5>Festivos guardados en este mes</h5>
<ul class="list-group">
  {% for f in existentes %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span>{{ f.fecha }}</span>
      <form method="post" action="{% url 'festivo_delete' f.pk %}">
        {% csrf_token %}
        <button class="btn btn-sm btn-outline-danger">Eliminar</button>
      </form>
    </li>
  {% empty %}
    <li class="list-group-item">No hay festivos guardados para este mes.</li>
  {% endfor %}
</ul>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/flatpickr.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}">
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const input = document.querySelector('input[name="fechas"]');
      if (!input) return;

      const añoInput = document.querySelector('input[name="año"], select[name="año"]');
      const mesInput = document.querySelector('input[name="mes"], select[name="mes"]');
      const año = parseInt(añoInput?.value || new Date().getFullYear(), 10);
      const mes = parseInt(mesInput?.value || (new Date().getMonth() + 1), 10);

      const firstDay = new Date(año, mes - 1, 1);
      const lastDay = new Date(año, mes, 0);

      flatpickr(input, {
        mode: "multiple",
        dateFormat: "Y-m-d",
        defaultDate: input.value ? input.value.split(",") : [],
        minDate: firstDay,
        maxDate: lastDay,
        onChange: function(selectedDates, dateStr, instance) {
          const formatted = selectedDates.map(d => instance.formatDate(d, "Y-m-d"));
          input.value = formatted.join(",");
        }
      });
    });
  </script>
{% endblock %}
