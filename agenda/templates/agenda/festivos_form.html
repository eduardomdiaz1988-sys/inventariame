{% extends "base.html" %}
{% load static %}

{% block content_authenticated %}
<h2>Seleccionar festivos del mes</h2>

<form method="post" id="festivosForm" class="mt-3">
  {% csrf_token %}
  <div class="mb-3">
    {{ form.año.label_tag }}
    {{ form.año }}
  </div>
  <div class="mb-3">
    {{ form.mes.label_tag }}
    {{ form.mes }}
  </div>
  <div class="mb-3">
    {{ form.fechas.label_tag }}
    {{ form.fechas }}
    <div class="form-text">Selecciona uno o más días festivos del mes.</div>
  </div>
  <button type="submit" class="btn btn-primary">Guardar</button>
  <a href="{% url 'mantenimiento_list' %}" class="btn btn-outline-secondary">Volver</a>
</form>

<hr class="my-4">

<h5>Festivos guardados en este mes</h5>
<ul class="list-group" id="festivosList">
  {% for f in existentes %}
    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ f.pk }}">
      <span>{{ f.fecha }}</span>
      <button class="btn btn-sm btn-outline-danger btn-delete" data-id="{{ f.pk }}">Eliminar</button>
    </li>
  {% empty %}
    <li class="list-group-item">No hay festivos guardados para este mes.</li>
  {% endfor %}
</ul>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/flatpickr.min.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/flatpickr.min.css' %}">
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const input = document.querySelector('input[name="fechas"]');
      if (!input) return;

      const añoInput = document.querySelector('input[name="año"], select[name="año"]');
      const mesInput = document.querySelector('input[name="mes"], select[name="mes"]');
      const año = parseInt(añoInput?.value || new Date().getFullYear(), 10);
      const mes = parseInt(mesInput?.value || (new Date().getMonth() + 1), 10);

      const firstDay = new Date(año, mes - 1, 1);
      const lastDay = new Date(año, mes, 0);

      // ✅ Preseleccionar festivos ya existentes
      const existentes = {{ existentes_json|json_script:"festivos-json" }};
      const defaultDates = existentes.map(f => f.fecha);

      flatpickr(input, {
        mode: "multiple",
        dateFormat: "Y-m-d",
        defaultDate: defaultDates,
        minDate: firstDay,
        maxDate: lastDay,
        onChange: function(selectedDates, dateStr, instance) {
          const formatted = selectedDates.map(d => instance.formatDate(d, "Y-m-d"));
          input.value = formatted.join(",");
        }
      });

      // ✅ AJAX eliminar festivo con actualización del calendario
      document.querySelectorAll(".btn-delete").forEach(btn => {
        btn.addEventListener("click", function(e) {
          e.preventDefault();
          const id = this.dataset.id;
          fetch("{% url 'agenda:festivo_delete_ajax' 0 %}".replace("0", id), {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            }
          }).then(resp => resp.json()).then(data => {
            if (data.status === "ok") {
              const item = document.querySelector(`li[data-id="${id}"]`);
              item.remove();

              // ✅ quitar fecha del input si estaba seleccionada
              const fecha = data.fecha;
              if (input && input.value) {
                const fechas = input.value.split(",").filter(f => f !== fecha);
                input.value = fechas.join(",");
              }
            }
          });
        });
      });
    });
  </script>
{% endblock %}
