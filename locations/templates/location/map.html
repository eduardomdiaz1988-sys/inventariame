{% extends "base.html" %}

{% block content_authenticated %}
<div class="container py-4">
  <h5 class="mb-3">Selecciona una ubicación en el mapa</h5>

  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div id="map" style="height: 480px; width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid #eee;"></div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
          <strong>Detalle de dirección</strong>
        </div>
        <div class="card-body">
          <div class="mb-2">
            <label class="form-label">Dirección</label>
            <input type="text" id="addressField" class="form-control" placeholder="Dirección reconocida" readonly>
          </div>
          <div class="row">
            <div class="col-6 mb-2">
              <label class="form-label">Latitud</label>
              <input type="text" id="latField" class="form-control" readonly>
            </div>
            <div class="col-6 mb-2">
              <label class="form-label">Longitud</label>
              <input type="text" id="lngField" class="form-control" readonly>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Etiqueta opcional</label>
            <input type="text" id="labelField" class="form-control" placeholder="Ej. Casa, Almacén">
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="useMyLocationBtn">
              Usar mi ubicación
            </button>
            <button class="btn btn-danger" id="saveBtn" disabled>
              Guardar dirección
            </button>
          </div>
          <div class="form-text mt-2">Pulsa en el mapa para seleccionar un punto.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Carga de Google Maps JS API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const addressField = document.getElementById("addressField");
  const latField = document.getElementById("latField");
  const lngField = document.getElementById("lngField");
  const labelField = document.getElementById("labelField");
  const saveBtn = document.getElementById("saveBtn");
  const useMyLocationBtn = document.getElementById("useMyLocationBtn");

  const fallbackSpain = { lat: 40.4168, lng: -3.7038 };
  let map, marker, geocoder;

  function initMap(center) {
    map = new google.maps.Map(document.getElementById("map"), {
      center: center || fallbackSpain,
      zoom: center ? 14 : 6,
      mapTypeControl: false,
      streetViewControl: false,
    });
    geocoder = new google.maps.Geocoder();

    // Click para colocar marcador y geocodificar
    map.addListener("click", (e) => {
      placeMarker(e.latLng);
      reverseGeocode(e.latLng);
    });
  }

  function placeMarker(latLng) {
    if (!marker) {
      marker = new google.maps.Marker({
        position: latLng,
        map,
        draggable: true,
        animation: google.maps.Animation.DROP,
      });
      // Al soltar el marcador, actualizar dirección
      marker.addListener("dragend", (e) => {
        reverseGeocode(e.latLng);
      });
    } else {
      marker.setPosition(latLng);
    }

    latField.value = latLng.lat().toFixed(6);
    lngField.value = latLng.lng().toFixed(6);
    saveBtn.disabled = !addressField.value;
  }

  function reverseGeocode(latLng) {
    geocoder.geocode({ location: latLng }, (results, status) => {
      if (status === "OK" && results && results.length) {
        const formatted = results[0].formatted_address;
        addressField.value = formatted;
        latField.value = latLng.lat().toFixed(6);
        lngField.value = latLng.lng().toFixed(6);
        saveBtn.disabled = false;
      } else {
        addressField.value = "";
        saveBtn.disabled = true;
      }
    });
  }

  // Intentar centrar en la ubicación del usuario
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const center = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        initMap(center);
      },
      () => initMap(fallbackSpain),
      { enableHighAccuracy: true, timeout: 8000 }
    );
  } else {
    initMap(fallbackSpain);
  }

  // Usar mi ubicación (coloca marcador y geocodifica)
  useMyLocationBtn.addEventListener("click", () => {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const latLng = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        map.setCenter(latLng);
        map.setZoom(15);
        placeMarker(latLng);
        reverseGeocode(latLng);
      }
    );
  });

  // Guardar dirección vía API
  saveBtn.addEventListener("click", async () => {
    const payload = {
      address: addressField.value,
      latitude: parseFloat(latField.value),
      longitude: parseFloat(lngField.value),
      label: labelField.value.trim()
    };

    try {
      const res = await fetch("{% url 'location_save_address' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (res.ok) {
        alert("Dirección guardada");
        labelField.value = "";
      } else {
        alert(data.error || "Error al guardar la dirección");
      }
    } catch (err) {
      console.error(err);
      alert("Error de red al guardar");
    }
  });

  // Helper CSRF (si no lo tienes ya global)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
});
</script>
{% endblock %}
