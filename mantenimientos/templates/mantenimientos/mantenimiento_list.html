{% extends "base.html" %}
{% load static %}
{% block content_authenticated %}
<h2>Mantenimientos</h2>

<div class="d-flex justify-content-between mb-3">
  <div>
    <a href="{% url 'mantenimiento_create' %}" class="btn btn-danger me-2">
      <i class="bi bi-plus-lg"></i> Nuevo
    </a>
    <a href="{% url 'mantenimiento_create' %}?fecha={{ today }}" class="btn btn-success">
      Registrar hoy
    </a>
  </div>
  <form method="get" class="d-flex">
    <input type="text" name="start" class="form-control flatpickr me-2" placeholder="Inicio" value="{{ request.GET.start }}">
    <input type="text" name="end" class="form-control flatpickr me-2" placeholder="Fin" value="{{ request.GET.end }}">
    <button type="submit" class="btn btn-outline-primary">Filtrar</button>
  </form>
</div>

<!-- EstadÃ­sticas rÃ¡pidas -->
<div class="alert alert-info mb-3">
  <strong>Total mes:</strong> {{ total_mes }} Â· 
  <strong>Promedio:</strong> {{ promedio }} Â· 
  <strong>MÃ¡ximo:</strong> {{ maximo }}
</div>

<table class="table table-hover">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Cantidad</th>
      <th>Creado</th>
      <th class="text-end">Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for m in mantenimientos %}
    <tr class="
      {% if m.cantidad <= 5 %}table-success
      {% elif m.cantidad <= 10 %}table-warning
      {% else %}table-danger{% endif %}
    " onclick="window.location.href='{% url 'mantenimiento_detail' m.pk %}'">
      <td>{{ m.fecha }}</td>
      <td>
        {{ m.cantidad }}
        {% if m.cantidad > 10 %}
          <span class="badge bg-danger ms-1">ðŸ”¥</span>
        {% endif %}
      </td>
      <td>{{ m.created_at|date:"Y-m-d H:i" }}</td>
      <td class="text-end">
        <a href="{% url 'mantenimiento_update' m.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
        <a href="{% url 'mantenimiento_delete' m.pk %}" class="btn btn-sm btn-outline-danger">Eliminar</a>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="4">Sin registros</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- GrÃ¡fico -->
<div class="mt-4">
  <canvas id="graficoMantenimientos"></canvas>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  flatpickr(".flatpickr", { dateFormat: "Y-m-d", locale: "es" });

  const ctx = document.getElementById('graficoMantenimientos');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ dias_json|safe }},
      datasets: [{
        label: 'Mantenimientos Ãºltimos 30 dÃ­as',
        data: {{ cantidades_json|safe }},
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    }
  });
</script>
{% endblock %}
